name: Package Tools

# Controls when the action will run
on:
  # Triggers the workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # Renamed job to "Build Package"
  BuildPackage:
    runs-on: ubuntu-latest
    # Set the MAJOR_VERSION environment variable
    env:
      MAJOR_VERSION: 0
    defaults:
      run:
        shell: bash
    steps:
      # Check out the repository's code
      - uses: actions/checkout@v2
        with:
          ref: 'master'
      # Find all files with the .meta extension and save the list to a file
      - run: |
          find . -name \*.meta >> metaList
      # Create a package directory
      - run: mkdir package

      # Use the create-unitypackage action to create a unity package from the .meta file list
      - uses: pCYSl5EDgo/create-unitypackage@master
        with:
          package-path: 'package/PFCToolkit.unitypackage'
          include-files: metaList
      # Rename the unity package file with the version number
      - name: Version release file
        run: mv "package/PFCToolkit.unitypackage" "package/PFCToolkit-v${MAJOR_VERSION}.${GITHUB_RUN_NUMBER}.unitypackage"
      # Use the automatic-releases action to create a new release and upload the unity package as an asset
      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{secrets.GITHUB_TOKEN}}"
          automatic_release_tag: "v${{ env.MAJOR_VERSION }}.${{ github.run_number }}"
          prerelease: false
          title: "v${{ env.MAJOR_VERSION }}.${{ github.run_number }} Release"
          files: |
              package/PFCToolkit-v${{ env.MAJOR_VERSION }}.${{ github.run_number }}.unitypackage
              _RUN_NUMBER}.unitypackage"
      # Use the automatic-releases action to create a new release and upload the unity package as an asset
      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{secrets.GITHUB_TOKEN}}"
          automatic_release_tag: "Latest"
          prerelease: false
          title: "Latest Release"
          files: |
              package/PFCToolkit-v${{ env.MAJOR_VERSION }}.${{ github.run_number }}.unitypackage
      # Echo the list of files in the package directory
      - name: Echo files
        run: ls package/
